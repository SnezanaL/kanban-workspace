<div
  class="flex gap-6 h-full overflow-x-auto p-6"
  (click)="openMenuKey.set(null)"
  (keydown.escape)="openMenuKey.set(null)"
  role="presentation"
>
  @for (column of board().columns; track column.name; let colIdx = $index) {
  <div class="flex flex-col min-w-[280px]">
    <!-- Column header -->
    <div class="flex items-center justify-between mb-3 px-1">
      <div class="flex items-center gap-2">
        <span class="h-2.5 w-2.5 rounded-full {{ getBadge(column.name, colIdx).dot }}"></span>
        <span
          class="text-xs font-semibold uppercase tracking-widest {{
            getBadge(column.name, colIdx).text
          }}"
        >
          {{ column.name }}
        </span>
        <span class="text-xs font-medium text-gray-400 dark:text-dark-200"
          >({{ column.tasks.length }})</span
        >
      </div>
      <button
        type="button"
        class="text-xs text-primary hover:underline font-medium"
        (click)="addTaskToColumn.emit(column.name)"
      >
        + Add
      </button>
    </div>

    <!-- Task cards -->
    <div class="flex flex-col gap-3 overflow-y-auto">
      @for (task of column.tasks; track task.title + $index) {
      <div
        class="card p-4 relative cursor-pointer"
        (click)="
          taskAction.emit({ type: 'edit', column: column.name, taskIndex: $index });
          openMenuKey.set(null)
        "
        (keydown.enter)="taskAction.emit({ type: 'edit', column: column.name, taskIndex: $index })"
        tabindex="0"
        role="button"
      >
        <!-- Top row: title + â‹® menu -->
        <div class="flex items-start justify-between gap-2 mb-1">
          <h4 class="font-semibold text-sm leading-snug flex-1">{{ task.title }}</h4>

          <!-- Three-dot menu button -->
          <div class="relative shrink-0">
            <button
              type="button"
              class="flex h-6 w-6 items-center justify-center rounded text-gray-400 hover:bg-gray-100 hover:text-gray-700 dark:hover:bg-dark-300 transition-colors text-base leading-none"
              (click)="toggleMenu(column.name, $index, $event)"
              title="More options"
            >
              &#x22EE;
            </button>

            @if (openMenuKey() === column.name + '-' + $index) {
            <div
              class="absolute right-0 top-7 z-50 w-32 rounded-lg border border-gray-100 dark:border-dark-300 bg-white dark:bg-dark-400 shadow-lg py-1"
            >
              <button
                type="button"
                class="w-full px-3 py-1.5 text-left text-xs text-gray-700 dark:text-dark-100 hover:bg-gray-50 dark:hover:bg-dark-300"
                (click)="
                  $event.stopPropagation();
                  taskAction.emit({ type: 'edit', column: column.name, taskIndex: $index });
                  openMenuKey.set(null)
                "
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="14"
                  height="14"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="inline mr-1 -mt-0.5"
                >
                  <path
                    d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z"
                  />
                  <path d="m15 5 4 4" />
                </svg>
                Edit
              </button>
              <button
                type="button"
                class="w-full px-3 py-1.5 text-left text-xs text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20"
                (click)="
                  $event.stopPropagation();
                  taskAction.emit({ type: 'delete', column: column.name, taskIndex: $index });
                  openMenuKey.set(null)
                "
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="14"
                  height="14"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="inline mr-1 -mt-0.5"
                >
                  <path d="M3 6h18" />
                  <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" />
                  <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />
                  <line x1="10" x2="10" y1="11" y2="17" />
                  <line x1="14" x2="14" y1="11" y2="17" />
                </svg>
                Delete
              </button>
            </div>
            }
          </div>
        </div>

        <!-- Description -->
        @if (task.description) {
        <p class="text-xs text-gray-500 dark:text-gray-400 mb-2 line-clamp-2">
          {{ task.description }}
        </p>
        }

        <!-- Subtask progress -->
        @if (task.subtasks.length > 0) {
        <div class="mb-3">
          <div class="flex justify-between text-xs text-gray-400 mb-1">
            <span>{{ getCompletedSubtasks(task) }} / {{ task.subtasks.length }} subtasks</span>
          </div>
          <div class="h-1 w-full rounded-full bg-gray-200 dark:bg-dark-300">
            <div
              class="h-1 rounded-full bg-primary transition-all"
              [style.width.%]="getSubtaskPercent(task)"
            ></div>
          </div>
        </div>
        }

        <!-- Status badge as inline select -->
        <div class="flex items-center gap-2">
          <div
            class="relative inline-flex items-center gap-1 rounded-full px-2 py-0.5
                {{ getBadge(column.name, colIdx).bg }}"
          >
            <span
              class="h-1.5 w-1.5 rounded-full shrink-0 {{ getBadge(column.name, colIdx).dot }}"
            ></span>
            <select
              class="appearance-none bg-transparent text-xs font-medium cursor-pointer pr-1
                    {{ getBadge(column.name, colIdx).text }}
                    focus:outline-none"
              [value]="column.name"
              (change)="onMoveTask(column.name, $index, $event)"
              (click)="$event.stopPropagation()"
            >
              @for (col of board().columns; track col.name) {
              <option [value]="col.name" [selected]="col.name === column.name">
                {{ col.name }}
              </option>
              }
            </select>
          </div>
        </div>
      </div>
      }
    </div>
  </div>
  }

  <!-- Add new column -->
  <div class="flex items-start pt-9 min-w-[200px]">
    <button
      type="button"
      class="w-full rounded-lg bg-gradient-to-b from-gray-200 to-gray-100 dark:from-dark-400 dark:to-dark-500 h-24 flex items-center justify-center text-sm font-bold text-gray-500 dark:text-dark-200 hover:text-primary transition-colors"
      (click)="addColumn.emit()"
    >
      + New Column
    </button>
  </div>
</div>
